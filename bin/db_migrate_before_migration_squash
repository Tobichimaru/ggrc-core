#!/usr/bin/env bash
# Copyright (C) 2018 Google Inc.
# Licensed under http://www.apache.org/licenses/LICENSE-2.0 <see LICENSE file>

set -o nounset
set -o errexit

usage () {
  cat <<EOF
Usage: $(basename ${0}) [SQL_DUMP_FILE]

Reset and migrate the database with an old db dump provided.
The script assumes that you aren't on the detached HEAD state
and don't have any unstaged changes.

Arguments:
  DUMPFILE : Mysql dump file that will be imported into the clean database.

Example usage:
  $(basename $0) ggrc-qa-dump.sql
EOF
  exit 0
}

if [ $# -eq 0 ]
then
  usage
fi

COMMIT_BEFORE_SQUASH="6f924682801a4205c10f3300a5e00608b6874b17"
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"

git checkout -q "$COMMIT_BEFORE_SQUASH"
db_reset "$1"
git checkout -q "$CURRENT_BRANCH"
db_migrate